# 入札情報ダウンローダー通知機能 (Google Apps Script)

このディレクトリには、入札情報ダウンローダーの通知機能を実装するGoogle Apps Script (GAS) のコードが含まれています。

## 機能概要

このスクリプトは以下の機能を提供します：

1. HTTPリクエストを受け取り、APIキーを検証する
2. 受け取ったデータをGmailとGoogle Chatに転送する
3. 通知の送信結果をJSON形式で返す

## デプロイ方法

### 1. Google Apps Scriptプロジェクトの作成

1. [Google Apps Script](https://script.google.com/) にアクセスする
2. 「新しいプロジェクト」をクリックする
3. プロジェクト名を「入札情報ダウンローダー通知」などに変更する

### 2. コードのコピー

1. `notification.js` の内容をコピーする
2. Google Apps Scriptエディタの `Code.gs` にペーストする

### 3. スクリプトプロパティの設定

1. Google Apps Scriptエディタのメニューから「実行」→「関数を実行」→「setupScriptProperties」を選択する
2. 以下の情報を入力する：
   - APIキー：クライアントアプリケーションからの認証に使用するキー
   - Google ChatのウェブフックURL（任意）：Google Chatに通知を送信する場合に設定
   - 通知先メールアドレス（任意）：メール通知を送信する場合に設定

### 4. Webアプリとしてデプロイ

1. Google Apps Scriptエディタのメニューから「デプロイ」→「新しいデプロイ」を選択する
2. 「種類の選択」で「ウェブアプリ」を選択する
3. 以下の設定を行う：
   - 説明：「入札情報ダウンローダー通知機能」など
   - ウェブアプリとして実行：「自分のアカウント」を選択
   - アクセスできるユーザー：「全員」を選択
4. 「デプロイ」ボタンをクリックする
5. 「アクセスを承認」をクリックし、必要な権限を許可する
6. デプロイが完了すると、「ウェブアプリのURL」が表示されるので、このURLをコピーする

### 5. クライアントアプリケーションの設定

1. コピーしたウェブアプリのURLを `config.toml` の `gasUrl` に設定する
2. 設定したAPIキーを `config.toml` の `apiKey` に設定する
3. 通知機能を有効にするために `enabled` を `true` に設定する

```toml
[notification]
enabled = true
gasUrl = "https://script.google.com/macros/s/your-deployment-id/exec"
apiKey = "your-api-key"
```

## テスト方法

### Google Apps Scriptエディタでのテスト

1. Google Apps Scriptエディタのメニューから「実行」→「関数を実行」→「testNotification」を選択する
2. 実行ログを確認し、通知が正常に送信されたことを確認する

### クライアントアプリケーションからのテスト

1. クライアントアプリケーションの設定が完了したら、アプリケーションを実行する
2. エラーが発生した場合や処理が完了した場合に、設定したGmailやGoogle Chatに通知が送信されることを確認する

## トラブルシューティング

### 通知が送信されない場合

1. スクリプトプロパティが正しく設定されているか確認する
2. クライアントアプリケーションの設定（`gasUrl` と `apiKey`）が正しいか確認する
3. Google Apps Scriptのログを確認する（メニューから「表示」→「ログ」を選択）
4. Google Apps Scriptの実行制限に達していないか確認する

### 権限エラーが発生する場合

1. Google Apps Scriptエディタのメニューから「実行」→「関数を実行」→「testNotification」を選択する
2. 必要な権限をすべて許可する
3. 再度デプロイを行う

## 注意事項

- APIキーは秘密情報として扱い、第三者に漏れないように注意してください
- Google Apps Scriptには実行制限があります。大量の通知を短時間に送信する場合は注意してください
- Webアプリとしてデプロイする際の「アクセスできるユーザー」の設定によっては、第三者からのアクセスが可能になる場合があります。APIキーによる認証を必ず行ってください